**制定日:** 2026-02-12  
**改正日:** 2026-02-12  
**バージョン:** 2.0

---

## 📜 前文

本憲法は、Clinic AI Systemの設計原則、アーキテクチャ方針、開発規約を定める最高規範である。

**改正理由:**  
初版憲法（画面別Controller設計）は2015年代の設計思想に基づいており、2026年のモダンWeb開発、特にSPA（Single Page Application）やモバイルアプリ対応には適さないと判断。Phase 0-2の実装を通じて、RESTful API設計の優位性が実証されたため、憲法をこれに準拠するよう改正する。

---

## 第1章: アーキテクチャ原則

### 第1条: APIファースト設計

本システムは**APIファースト**を採用する。

1. すべての機能はRESTful APIとして実装される
2. バックエンドはJSON形式でのみデータを返却する
3. フロントエンドはバックエンドから完全に分離される
4. 複数のフロントエンド（Web/モバイル）に対応可能な設計とする

**技術的根拠:**
- スケーラビリティの確保
- フロントエンド技術選択の自由
- モバイルアプリとの連携容易性
- マイクロサービス化への対応

---

### 第2条: リソース中心設計

APIはリソース（Resource）を中心に設計される。

**主要リソース:**
- `Visit`: 来院情報（患者の受付から終了までの状態を管理）
- `Patient`: 患者情報（将来実装）
- `Staff`: スタッフ情報（将来実装）

**原則:**
- 1つのリソースは1つのControllerで管理
- 状態遷移は明示的なエンドポイントで表現
- RESTful原則に従う（GET/POST/PUT/DELETE）

---

### 第3条: 状態遷移の明示性

Visitリソースの状態遷移（S0→S1→S2→...→S9）は、**明示的なAPIエンドポイント**で表現される。

**例:**
POST /api/visits/accept/manual → S0→S1（受付） POST /api/visits/{id}/call → S2→S3（呼出） POST /api/visits/{id}/enter → S3→S4（入室）

Code

**禁止事項:**
- 暗黙的な状態遷移
- 複数の状態を1つのエンドポイントで変更
- 状態遷移のバリデーション省略

---

## 第2章: ディレクトリ構成

### 第4条: Controller構成

app/Http/Controllers/ └── Api/ └── VisitController.php ← Visitリソースのすべての操作

Code

**原則:**
- 画面別ではなく**リソース別**にController配置
- `Api/`配下にすべてのAPIコントローラを配置
- 1リソース = 1コントローラ

**削除された旧Controller:**
- ❌ Reception/ReceptionController
- ❌ Waitingroom/WaitingRoomController
- ❌ Exam/ExamController
- ❌ Exam/ExamSessionController

これらは憲法改正により廃止された。

---

### 第5条: ルーティング構成

routes/ ├── api.php ← すべてのAPIルート └── web.php ← 最小限（ルートページのみ）

Code

**api.phpの役割:**
- すべてのRESTful APIエンドポイント定義
- `/api/`プレフィックス自動付与
- JSON形式でレスポンス

**web.phpの役割:**
- ルートページ（`/`）のみ
- APIドキュメントへのリダイレクト等

---

## 第3章: 開発規約

### 第6条: テスト駆動開発（TDD）

すべての新機能実装は、テストから開始する。

**手順:**
1. Feature Testを先に記述
2. テストを実行（失敗を確認）
3. 実装
4. テスト成功を確認

**目標カバレッジ:**
- 全体: 90%以上
- API Controller: 100%

---

### 第7条: 状態遷移の厳格性

状態遷移は`VisitStateService`を経由して行う。

**禁止事項:**
- Controllerで直接`current_state`を変更
- バリデーションなしの状態遷移
- 状態ログ記録の省略

---

### 第8条: エラーハンドリングの統一

すべてのAPIエラーは、統一形式で返却する。

**成功レスポンス:**
```json
{
  "success": true,
  "data": { ... }
}
エラーレスポンス:

JSON
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ"
  }
}
第4章: Phase別実装計画
第9条: Phase定義
Phase 0: 基盤構築 ✅

状態マシン実装
データベース設計
状態遷移サービス
Phase 1: 受付機能 ✅

QR受付API
手動受付API
一覧・詳細取得API
Phase 2: 呼出機能 ✅

呼出API
診察室入室API
不在マークAPI
再呼出API
Phase 3: 診察・会計機能 🔄

待機開始API
診察終了API
会計完了API
来院終了API
Phase 4: フロントエンド 予定

Next.js実装
受付画面
待合室モニター
Phase 5: AI機能統合 予定

AI問診
診察支援
第5章: Git運用規約
第10条: ブランチ戦略
Code
main          ← 本番環境
  ↑
develop       ← 開発環境
  ↑
feature/*     ← 機能開発ブランチ
第11条: コミットメッセージ
Code
[Phase X-Y] 機能名: 詳細

例:
[Phase 2-1] 呼出API: S2→S3遷移を実装
[Phase 3-1] 診察終了API: S4→S6遷移を実装
第6章: 改正手続き
第12条: 憲法改正
憲法は、以下の条件で改正できる：

技術的必要性���証明

現行憲法では実現不可能な要件
パフォーマンス・保守性の著しい改善
実装による検証

プロトタイプ実装で有効性を確認
既存システムへの影響を評価
文書化

改正理由を明記
移行計画を策定
憲法は絶対ではない。より良いシステムのために進化する。

付則
第1項: 旧憲法の廃止
初版憲法（画面別Controller設計）は、本憲法の施行により廃止される。

第2項: 施行日
本憲法は、2026年2月12日より施行する。